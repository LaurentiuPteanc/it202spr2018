<!DOCTYPE html>
<html lang="en">
<head>
  <title>Final Game</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  
  <script type="text/javascript" src="https://material-components-web.appspot.com/assets/material-components-web.js"></script>
  <!-- the MCW stylesheet-->
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  <!-- the material icon font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="manifest" href="./manifest.json">
  <style type="text/css">
    body{   
    margin:0 auto; }
    .hide{
      display:none;
    }
    .mdc-layout-grid{
      margin:0;
      padding:0!important;
    }
  </style>
  <script type="text/javascript" src="./js/screens.js"></script>
  <script type="text/javascript" src="./js/monsters.js"></script>
</head>

  <body style="height:97vh">

    <nav id="toolbar" class="mdc-tab-bar custom-tab-bar-in-toolbar mdc-tab-bar-upgraded mdc-typography--display4">
      <a id="mapTab" class="mdc-tab mdc-tab--active mdc-ripple-upgraded" href="#one" style="--mdc-ripple-fg-size:96px; --mdc-ripple-fg-scale:1.84422;" onclick="showMap()" data-mdc-auto-init="MDCRipple">Map</a>
      <a id="inventoryTab" class="mdc-tab mdc-ripple-upgraded " href="#two" style="--mdc-ripple-fg-size:96px; --mdc-ripple-fg-scale:1.84422;" onclick="showInventory()" data-mdc-auto-init="MDCRipple">Inventory</a>
      <a id="equipmentTab" class="mdc-tab mdc-ripple-upgraded" href="#three" style="--mdc-ripple-fg-size:96px; --mdc-ripple-fg-scale:1.84422;" onclick="showEquipment()" data-mdc-auto-init="MDCRipple">Equipment</a>

    </nav>

    
 
    <div id="mapScreen" style="height:93%;width:100%;">
      <div id="map" style="height:100%;width:100%;"></div>
      <button onclick="getPlaces()" >getPlaces</button>
      <button onclick="getCrimes()" >getCrimes</button>
    </div>
    <div id="inventoryScreen">
    </div>
    <div id="battleScreen" height="100%" width="100%">
        <canvas id="battleCanvas" height="75%" width="100%"></canvas>
  
  
  
  <div class="mdc-layout-grid">
    <div class="mdc-layout-grid__inner">
      <div class="mdc-layout-grid__cell">
        <div class= "mdc-card">
          <div class="mdc-card__actions mdc-card__actions--full-bleed">
              <button class="mdc-button mdc-card__action mdc-card__action--button mdc-ripple-surface" data-mdc-auto-init="MDCRipple" onclick="fightAction()">Fight</button>
          </div>
        </div>
      </div>
      <div class="mdc-layout-grid__cell">
        <div class= "mdc-card">
          <div class="mdc-card__actions mdc-card__actions--full-bleed">
              <button class="mdc-button mdc-card__action mdc-card__action--button mdc-ripple-surface" data-mdc-auto-init="MDCRipple">Inventory</button>
          </div>
        </div>
      </div>
      <div class="mdc-layout-grid__cell">
        <div class= "mdc-card">
          <div class="mdc-card__actions mdc-card__actions--full-bleed">
            <button class="mdc-button mdc-card__action mdc-card__action--button mdc-ripple-surface" data-mdc-auto-init="MDCRipple">escape</button>
          </div>
        </div>
      </div>
      <div class="mdc-layout-grid__cell">
        <div class= "mdc-card">
          <div class="mdc-card__actions mdc-card__actions--full-bleed">
            <button class="mdc-button mdc-card__action mdc-card__action--button mdc-ripple-surface" data-mdc-auto-init="MDCRipple">Action 4</button>
          </div>
        </div>
      </div>
    </div>
  </div>
        <!--Buttons to add:
              Main:
                Fight,
                Equipment,
                Flee,
              Fight: ?
                Weapon, ?
              Equipment:
                List usable equipment
              
              -->
    </div>
    <img id="background" class='hide' src="./img/background.jpg">
    <img id="playerImg" class='hide' src="./img/player.png">
    <img id="monsterImg" class='hide' src="./img/monster.png">
    <script>
    
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./service-worker.js')
      .then(function(reg){
        console.log("registered sw");
      }).catch(function(err){
        console.log(err);
      });
    }
    
    var map;
    var heatmap;
    var mapStyle = [
  {
    "elementType": "labels",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "administrative.neighborhood",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "poi.business",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "road",
    "elementType": "labels.icon",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "transit",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  }
];
    var monsters = [];
    var frames = 0;
    var curAnimation = 'map';
    var battleCanvas = $('#battleCanvas')[0];
    var curMonster = 0;
    var battleContext = battleCanvas.getContext('2d');
    var player = {latlng:{lat:41.874010999999996,lng:-87.6526106},
              district:'12',
              marker:null,
              animations:"player",
              icon: null,
              /*{url:"./img/player.png",
              scaledSize: new google.maps.Size(50, 50), // scaled size
                    origin: new google.maps.Point(0,0), // origin
                    anchor: new google.maps.Point(0, 0) // anchor
              },*/
              inventory:{},
              level:1,
              health:50,
              attack:1,
              defense:1,
              armor:0,
              weapon:0,
              gold:0
    
}
    getDistrict(player.latlng);
    console.log(player.district)

    $(document).ready(function(){ 
      $("#mapScreen").show();
      $("#inventoryScreen").hide();
      $("#battleScreen").hide();
    }); 
    
    
    
    
    
    function getPlaces(){
      var baseUrl = 'https://maps.googleapis.com/maps/api/place/nearbysearch/json?location='
      var lat = player.latlng.lat;//'-33.8670'
      var lng = player.latlng.lng;//'151.1957'
      var radius = '500';
      var type = 'bank';
      var name = '';
      var key = 'AIzaSyAhKjUtfMz2x_JzgOQe5sPu1uBno2ygk1U';
      
     // https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=-33.8670,151.1957&radius=500&types=food&name=cruise&key=YOUR_API_KEY
     
      $.ajax({
        url:baseUrl+lat+','+lng+'&radius='+radius+'&types='+type+'&key='+key,
        headers: {
         'Access-Control-Allow-Origin':'*'
        },
        dataType: 'json',
        method:'GET',
        success: function(data){
         console.log(data);
        }
         
      });
     /*$.get(baseUrl+lat+','+lng+'&radius='+radius+'&types='+type+'&key='+key,
      function(data){
        console.log(data);
      });
      $.get;*/
    }
    function getDistrict(pos){
      var url='https://data.cityofchicago.org/resource/24zt-jpfn.json';
      var query = '?$select=dist_num,simplify_preserve_topology(the_geom, 0.001) as the_geom'
    
      $.get(url+query,function(data){
        $.each(data,function(i,v){
          //console.log(v.the_geom.coordinates[0][0])
          if(inside([pos.lng,pos.lat],v.the_geom.coordinates[0][0]) == true){
            console.log('true '+v.dist_num);
            console.log(player.district)
            var last_dist = player.district;
            
            player.district=''+v.dist_num
            if(player.district != last_dist){
              console.log('getting crimes')
              heatmap.setMap(null)
              getCrimes(); 
            }
          }
        })
        
      })
      
      
    }
    function inside(point, vs) {
        // ray-casting algorithm based on
        // http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html
        
        var x = point[0], y = point[1];
    
        var inside = false;
        for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
            var xi = vs[i][0], yi = vs[i][1];
            var xj = vs[j][0], yj = vs[j][1];
    
            var intersect = ((yi > y) != (yj > y))
                && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
    
        return inside;
    };
    function getCrimes(){
      var dist;
      if(player.district <10){
        dist = '00'+player.district;
      } else {
        dist = '0'+player.district;
      }
      $.get('https://data.cityofchicago.org/resource/6zsd-86xi.json?$query=select * where date>"2017-01-01T00:00:00.000" and location is not null and district = "'+dist+'"',
        function(data){
          console.log(data);
          var crime_locs = [];
          
          $.each(data, function(i,v){
            //console.log(v);
            crime_locs.push(new google.maps.LatLng(v.location.coordinates[1], v.location.coordinates[0]));
          });
          
          console.log(crime_locs)
          
          
          
          heatmap = new google.maps.visualization.HeatmapLayer({
            data: crime_locs,
            map: map
          });
          
          //heatmap.set('radius',200);
        });
    }
    
    function animate(){
      if(curAnimation == 'map'){
        mapAnimation();
      }
      else {
        battleAnimation();
      }
    }
    
    function battleAnimation(){
      
      battleContext.drawImage($('#background')[0],0,0,battleCanvas.width,battleCanvas.height)
      battleContext.drawImage($('#playerImg')[0],battleCanvas.width*.2,battleCanvas.height*.45,battleCanvas.width*.28,battleCanvas.height*.55)
      battleContext.drawImage($('#monsterImg')[0],battleCanvas.width*.65,battleCanvas.height*.25,battleCanvas.width*.2,battleCanvas.height*.45)
      battleContext.font = "30px Arial";
      battleContext.fillText("Monster: "+monsters[curMonster].health,20,20)
      
      
      window.requestAnimationFrame(animate);
    }
    
    function mapAnimation(){
      //console.log("here")
      
      var spawnMonster = Math.random()*100;
      //console.log(spawnMonster);
      if(spawnMonster < 1){
        addMonster();
        
      }
      
      var monsterInd = monsters.length-1;
      
      while(monsterInd>0){
        var mon = monsters[monsterInd]
        mon.timeout--;
        if(mon.timeout<=0){
          console.log("splicing")
          mon.marker.setMap(null);
          monsters.splice(monsterInd,1)
        }
        monsterInd--;
      }

      window.requestAnimationFrame(animate);
      
      
    }
    
    function fightAction(){
      var mon = monsters[curMonster];
      
      var atk = Math.floor(Math.random()*20)+player.attack+player.weapon;
      var def = mon.defense;
      
      if(atk>def){
        mon.health -= atk-def;
      }
      
      if(mon.health <= 0){
        showMap();
        player.gold += mon.gold;
        monsters.splice(curMonster,1);
        mon.marker.setMap(null);
        curAnimation = 'map';
      }
    }
    
    
    </script>
    <script type="text/javascript" src="./js/mapFunctions.js"></script>
    <script type="text/javascript" src="./js/geolocation.js"></script>
     <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1fUKamtuwCvGlTQrA06yfUzJ33bhtAGg&libraries=visualization&callback=initMap">
    </script>

    <!-- Material Components Script -->
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.js"></script>
    <script>mdc.autoInit();</script>
  </body>
</html>

